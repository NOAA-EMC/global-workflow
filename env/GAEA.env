#! /usr/bin/env bash

if [[ $# -ne 1 ]]; then

    echo "Must specify an input argument to set runtime environment variables!"
    exit 1

fi

step=$1

export launcher="srun -l --export=ALL"
export mpmd_opt="--multi-prog --output=mpmd.%j.%t.out"

ulimit -s unlimited
ulimit -a

# Calculate common variables
nth_max=$((npe_node_max / npe_node))
NTHREADSmax=${nth:-${nth_max}}
NTHREADS1=${nth:-1}
[[ ${NTHREADSmax} -gt ${nth_max} ]] && NTHREADSmax=${nth_max}
[[ ${NTHREADS1} -gt ${nth_max} ]] && NTHREADS1=${nth_max}
APRUN="${launcher} -n ${npe}"

if [[ "${step}" = "fcst" ]]; then

    ppn="npe_node_${RUN}"
    [[ -z "${!ppn+0}" ]] && ppn="npe_node"
    nprocs="npe_${RUN}"
    [[ -z ${!nprocs+0} ]] && nprocs="npe"

    (( nnodes = (${!nprocs}+${!ppn}-1)/${!ppn} ))
    (( ntasks = nnodes*${!ppn} ))
    # With ESMF threading, the model wants to use the full node
    export APRUN_UFS="${APRUN}"
    unset nprocs ppn nnodes ntasks

elif [[ "${step}" = "atmos_products" ]]; then

    export USE_CFP="YES"  # Use MPMD for downstream product generation

fi
