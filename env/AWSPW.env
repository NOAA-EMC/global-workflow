#! /usr/bin/env bash

if [[ $# -ne 1 ]]; then

    echo "Must specify an input argument to set runtime environment variables!"
    exit 1

fi

step=$1

export launcher="srun -l --export=ALL"
export mpmd_opt="--multi-prog --output=mpmd.%j.%t.out"

# export POSTAMBLE_CMD='report-mem'

# Configure MPI environment
export OMP_STACKSIZE=2048000
export NTHSTACK=1024000000

# Setting stacksize to unlimited on login nodes is prohibited
if [[ -n "${SLURM_JOB_ID:-}" ]]; then
    ulimit -s unlimited
    ulimit -a
fi

if [[ "${step}" = "prep" ]] || [[ "${step}" = "prepbufr" ]]; then

    nth_max=$((npe_node_max / npe_node_prep))

    export POE="NO"
    export BACK="NO"
    export sys_tp="HERA"
    export launcher_PREP="srun"

elif [[ "${step}" = "fcst" ]] || [[ "${step}" = "efcs" ]]; then

    export launcher="srun --mpi=pmi2 -l"

    ppn="npe_node_${step}_${RUN}"
    [[ -z "${!ppn+0}" ]] && ppn="npe_node_${step}"
    nprocs="npe_${step}_${RUN}"
    [[ -z ${!nprocs+0} ]] && nprocs="npe_${step}"

    (( nnodes = (${!nprocs}+${!ppn}-1)/${!ppn} ))
    (( ntasks = nnodes*${!ppn} ))
    # With ESMF threading, the model wants to use the full node
    export APRUN_UFS="${launcher} -n ${ntasks}"
    unset nprocs ppn nnodes ntasks

elif [[ "${step}" = "atmos_products" ]]; then

    export USE_CFP="YES"  # Use MPMD for downstream product generation on Hera

fi
