<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GFS Physics Documentation: gwdps.f Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="ccpp_dox_extra_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ncep.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">GFS Physics Documentation
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('gwdps_8f_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">gwdps.f</div>  </div>
</div><!--header-->
<div class="contents">
<a href="gwdps_8f.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="keyword">      SUBROUTINE </span><a class="code" href="group___g_f_s__ogwd.html#ga82eda62e1bdee0a0ab6a831fc53ae89c">gwdps</a>(IM,IX,IY,KM,A,B,C,U1,V1,T1,Q1,KPBL,              &amp;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;     &amp;               PRSI,DEL,PRSL,PRSLK,PHII, PHIL,DELTIM,KDT,         &amp;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;     &amp;               HPRIME,OC,OA4,CLX4,THETA,SIGMA,GAMMA,ELVMAX,       &amp;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;     &amp;               DUSFC,DVSFC,G, CP, RD, RV, IMX,                    &amp;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;     &amp;               nmtvr, cdmbgwd, me, lprnt, ipr,  rdxzb)</div><div class="line"><a name="l00342"></a><span class="lineno"><a class="line" href="group___g_f_s__ogwd.html#ga82eda62e1bdee0a0ab6a831fc53ae89c">  342</a></span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="comment">!   ********************************************************************</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment">! -----&gt;  I M P L E M E N T A T I O N    V E R S I O N   &lt;----------</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="comment">!          --- Not in this code --  History of GWDP at NCEP----</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="comment">!              ----------------     -----------------------</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment">!  VERSION 3  MODIFIED FOR GRAVITY WAVES, LOCATION: .FR30(V3GWD)  *J*</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="comment">!---       3.1 INCLUDES VARIABLE SATURATION FLUX PROFILE CF ISIGST</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="comment">!---       3.G INCLUDES PS COMBINED W/ PH (GLAS AND GFDL)</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="comment">!-----         ALSO INCLUDED IS RI  SMOOTH OVER A THICK LOWER LAYER</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="comment">!-----         ALSO INCLUDED IS DECREASE IN DE-ACC AT TOP BY 1/2</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="comment">!-----     THE NMC GWD INCORPORATING BOTH GLAS(P&amp;S) AND GFDL(MIGWD)</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment">!-----        MOUNTAIN INDUCED GRAVITY WAVE DRAG </span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="comment">!-----    CODE FROM .FR30(V3MONNX) FOR MONIN3</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="comment">!-----        THIS VERSION (06 MAR 1987)</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="comment">!-----        THIS VERSION (26 APR 1987)    3.G</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="comment">!-----        THIS VERSION (01 MAY 1987)    3.9</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment">!-----    CHANGE TO FORTRAN 77 (FEB 1989)     --- HANN-MING HENRY JUANG</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment">!-----    20070601 ELVMAX bug fix (*j*)</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment">!   VERSION 4</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment">!                ----- This code -----</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">!-----   MODIFIED TO IMPLEMENT THE ENHANCED LOW TROPOSPHERIC GRAVITY</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment">!-----   WAVE DRAG DEVELOPED BY KIM AND ARAKAWA(JAS, 1995).</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="comment">!        Orographic Std Dev (hprime), Convexity (OC), Asymmetry (OA4)</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="comment">!        and Lx (CLX4) are input topographic statistics needed.</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="comment">!-----   PROGRAMMED AND DEBUGGED BY HONG, ALPERT AND KIM --- JAN 1996.</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="comment">!-----   debugged again - moorthi and iredell --- may 1998.</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="comment">!-----</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="comment">!       Further Cleanup, optimization and modification</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="comment">!                                       - S. Moorthi May 98, March 99.</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="comment">!-----   modified for usgs orography data (ncep office note 424)</span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="comment">!        and with several bugs fixed  - moorthi and hong --- july 1999.</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment">!-----   Modified &amp; implemented into NRL NOGAPS</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment">!                                       - Young-Joon Kim, July 2000</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="comment">!-----</span></div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;<span class="comment">!   VERSION lm MB  (6): oz fix 8/2003</span></div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="comment">!                ----- This code -----</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="comment">!------   Changed to include the Lott and Miller Mtn Blocking</span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="comment">!         with some modifications by (*j*)  4/02</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment">!        From a Principal Coordinate calculation using the</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="comment">!        Hi Res 8 minute orography, the Angle of the</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="comment">!        mtn with that to the East (x) axis is THETA, the slope</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="comment">!        parameter SIGMA. The anisotropy is in GAMMA - all  are input</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment">!        topographic statistics needed.  These are calculated off-line</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">!        as a function of model resolution in the fortran code ml01rg2.f,</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="comment">!        with script mlb2.sh.   (*j*)</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="comment">!-----   gwdps_mb.f version (following lmi) elvmax &lt; hncrit (*j*)</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="comment">!        MB3a expt to enhance elvmax mtn hgt see sigfac &amp; hncrit</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment">!        gwdps_GWDFIX_v6.f FIXGWD GF6.0 20070608 sigfac=4.</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="comment">!-----</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="comment">!----------------------------------------------------------------------C</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="comment">!    USE</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment">!        ROUTINE IS CALLED FROM GBPHYS  (AFTER CALL TO MONNIN)</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="comment">!    PURPOSE</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="comment">!        USING THE GWD PARAMETERIZATIONS OF PS-GLAS AND PH-</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="comment">!        GFDL TECHNIQUE.  THE TIME TENDENCIES OF U V</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">!        ARE ALTERED TO INCLUDE THE EFFECT OF MOUNTAIN INDUCED</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="comment">!        GRAVITY WAVE DRAG FROM SUB-GRID SCALE OROGRAPHY INCLUDING</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="comment">!        CONVECTIVE BREAKING, SHEAR BREAKING AND THE PRESENCE OF</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="comment">!        CRITICAL LEVELS</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="comment">!  INPUT</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="comment">!        A(IY,KM)  NON-LIN TENDENCY FOR V WIND COMPONENT</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="comment">!        B(IY,KM)  NON-LIN TENDENCY FOR U WIND COMPONENT</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="comment">!        C(IY,KM)  NON-LIN TENDENCY FOR TEMPERATURE</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="comment">!        U1(IX,KM) ZONAL WIND M/SEC  AT T0-DT</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="comment">!        V1(IX,KM) MERIDIONAL WIND M/SEC AT T0-DT</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="comment">!        T1(IX,KM) TEMPERATURE DEG K AT T0-DT</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="comment">!        Q1(IX,KM) SPECIFIC HUMIDITY AT T0-DT</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="comment">!        DELTIM  TIME STEP    SECS</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="comment">!        SI(N)   P/PSFC AT BASE OF LAYER N</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="comment">!        SL(N)   P/PSFC AT MIDDLE OF LAYER N</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="comment">!        DEL(N)  POSITIVE INCREMENT OF P/PSFC ACROSS LAYER N</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="comment">!        KPBL(IM) is the index of the top layer of the PBL</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;<span class="comment">!        ipr &amp; lprnt for diagnostics</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="comment">!  OUTPUT</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="comment">!        A, B    AS AUGMENTED BY TENDENCY DUE TO GWDPS</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="comment">!                OTHER INPUT VARIABLES UNMODIFIED.</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;<span class="comment">!  revision log:</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="comment">!    May 2013  J. Wang change cleff back to opn setting</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment">!    Jan 2014  J. Wang merge Henry and Fangin&#39;s dissipation heat in gfs to nems </span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="comment">!     </span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;<span class="comment">!   ********************************************************************</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;      <span class="keywordtype">USE </span>machine <span class="keywordtype">, ONLY</span> : kind_phys</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;      <span class="keywordtype">implicit none</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;      <span class="keywordtype">integer</span> im, iy, ix, km, imx, kdt, ipr, me</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;      <span class="keywordtype">integer</span> KPBL(im)                 <span class="comment">! Index for the PBL top layer!</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> deltim, G, CP, RD, RV,      cdmbgwd(2)</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> A(iy,km),    B(iy,km),      C(iy,km),        &amp;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;     &amp;                     U1(IX,KM),   V1(IX,KM),     T1(IX,KM),       &amp;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;     &amp;                     Q1(IX,KM),   PRSI(IX,KM+1), DEL(IX,KM),      &amp;</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;     &amp;                     PRSL(IX,KM), PRSLK(IX,KM),  PHIL(IX,KM),     &amp;</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;     &amp;                     PHII(IX,KM+1),RDXZB(IY)</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> OC(im),     OA4(iy,4), CLX4(iy,4)            &amp;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;     &amp;,                    HPRIME(IM)</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;<span class="comment">! for lm mtn blocking</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> ELVMAX(im),THETA(im),SIGMA(im),GAMMA(im)</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> wk(im)</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> bnv2lm(im,km),PE(im),EK(im),ZBK(im),UP(im)</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> DB(im,km),ANG(im,km),UDS(im,km)</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> ZLEN, DBTMP, R, PHIANG, CDmb, DBIM</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> ENG0, ENG1</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="comment">!     Some constants</span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> pi, dw2min, rimin, ric, bnv2min, efmin</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;     &amp;,                    efmax,hpmax,hpmin, rad_to_deg, deg_to_rad</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;      parameter(pi=3.1415926535897931)</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;      parameter(rad_to_deg=180.0/pi, deg_to_rad=pi/180.0)</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;      parameter(dw2min=1., rimin=-100., ric=0.25, bnv2min=1.0e-5)</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="comment">!     PARAMETER (EFMIN=0.0, EFMAX=10.0, hpmax=200.0)</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;      parameter(efmin=0.0, efmax=10.0, hpmax=2400.0, hpmin=1.0)</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> FRC,    CE,     CEOFRC, frmax, CG, GMAX</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;     &amp;,                    veleps, factop, rlolev, rdi</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="comment">!     &amp;,                    CRITAC, VELEPS, FACTOP, RLOLEV, RDI</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;      parameter(frc=1.0, ce=0.8, ceofrc=ce/frc, frmax=100., cg=0.5)</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;      parameter(gmax=1.0, veleps=1.0, factop=0.5)</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="comment">!      parameter (GMAX=1.0, CRITAC=5.0E-4, VELEPS=1.0, FACTOP=0.5)</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;      parameter(rlolev=50000.0) </div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="comment">!     parameter (RLOLEV=500.0) </span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="comment">!     parameter (RLOLEV=0.5)</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;       <span class="keywordtype">real(kind=kind_phys)</span> dpmin,hminmt,hncrit,minwnd,sigfac</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="comment">! --- for lm mtn blocking</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="comment">!     parameter (cdmb = 1.0)     ! non-dim sub grid mtn drag Amp (*j*)</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;      parameter(hncrit=8000.)   <span class="comment">! Max value in meters for ELVMAX (*j*)</span></div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="comment">!  hncrit set to 8000m and sigfac added to enhance elvmax mtn hgt</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;      parameter(sigfac=4.0)     <span class="comment">! MB3a expt test for ELVMAX factor (*j*)</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;      parameter(hminmt=50.)     <span class="comment">! min mtn height (*j*)</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;      parameter(minwnd=0.1)     <span class="comment">! min wind component (*j*)</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="comment">!     parameter (dpmin=00.0)     ! Minimum thickness of the reference layer</span></div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="comment">!!    parameter (dpmin=05.0)     ! Minimum thickness of the reference layer</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="comment">!     parameter (dpmin=20.0)     ! Minimum thickness of the reference layer</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                                 <span class="comment">! in centibars</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;      parameter(dpmin=5000.0)   <span class="comment">! Minimum thickness of the reference layer</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                                 <span class="comment">! in Pa</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> FDIR</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;      <span class="keywordtype">integer</span> mdir</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;      parameter(mdir=8, fdir=mdir/(pi+pi))</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;      <span class="keywordtype">integer</span> nwdir(mdir)</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;      <span class="keyword">data</span> nwdir/6,7,5,8,2,3,1,4/</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;      <span class="keywordtype">save</span> nwdir</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;      <span class="keywordtype">LOGICAL</span> ICRILV(im)</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="comment">!----   MOUNTAIN INDUCED GRAVITY WAVE DRAG</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> TAUB(im),  XN(im),     YN(im),    UBAR(im)     &amp;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;     &amp;,                    VBAR(IM),  ULOW(IM),   OA(IM),    CLX(IM)      &amp;</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;     &amp;,                    ROLL(IM),  ULOI(IM),   DUSFC(IM), DVSFC(IM)    &amp;</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;     &amp;,                    DTFAC(IM), XLINV(IM),  DELKS(IM), DELKS1(IM)</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> BNV2(im,km),  TAUP(im,km+1), ri_n(im,km)       &amp;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;     &amp;,                    TAUD(IM,KM),  RO(IM,KM),     VTK(IM,KM)        &amp;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;     &amp;,                    VTJ(IM,KM),   SCOR(IM),      VELCO(IM,KM-1)    &amp;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;     &amp;,                    bnv2bar(im)</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="comment">!     real(kind=kind_phys) VELKO(KM-1)</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;      <span class="keywordtype">Integer</span>   kref(im), kint(im), iwk(im), ipt(im)</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">! for lm mtn blocking</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;      <span class="keywordtype">Integer</span>   kreflm(im), iwklm(im)</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;      <span class="keywordtype">Integer</span>   idxzb(im), ktrial, klevm1, nmtvr</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> gor,    gocp,  fv,    gr2,  bnv,  fr           &amp;</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;     &amp;,                    brvf,   cleff, tem,   tem1,  tem2, temc, temv  &amp;</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;     &amp;,                    wdir,   ti,    rdz,   dw2,   shr2, bvf2        &amp;</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;     &amp;,                    rdelks, efact, coefm, gfobnv                   &amp;</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;     &amp;,                    scork,  rscor, hd,    fro,   rim,  sira        &amp;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;     &amp;,                    dtaux,  dtauy, pkp1log, pklog</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;      <span class="keywordtype">integer</span> kmm1, kmm2, lcap, lcapp1, kbps, kbpsp1,kbpsm1               &amp;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;     &amp;, kmps, idir, nwd, i, j, k, klcap, kp1, kmpbl, npt, npr             &amp;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;     &amp;, kmll                                </div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="comment">!    &amp;, kmll,kmds,ihit,jhit</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;      <span class="keywordtype">logical</span> lprnt</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="comment">!     parameter (cdmb = 1.0)     ! non-dim sub grid mtn drag Amp (*j*)</span></div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="comment">! non-dim sub grid mtn drag Amp (*j*)</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="comment">!     cdmb = 1.0/float(IMX/192)</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="comment">!     cdmb = 192.0/float(IMX)</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;      cdmb = 4.0 * 192.0/float(imx)</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;      <span class="keywordflow">if</span> (cdmbgwd(1) &gt;= 0.0) cdmb = cdmb * cdmbgwd(1)</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;      npr = 0</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;      <span class="keywordflow">DO</span> i = 1, im</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;         dusfc(i) = 0.</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;         dvsfc(i) = 0.</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;      <span class="keywordflow">DO</span> k = 1, km</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        <span class="keywordflow">DO</span> i = 1, im</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;          db(i,k)  = 0.</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;          ang(i,k) = 0.</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;          uds(i,k) = 0.</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      rdi  = 1.0 / rd</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;      gor  = g/rd</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;      gr2  = g*gor</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;      gocp = g/cp</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;      fv   = rv/rd - 1</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="comment">!     NCNT   = 0</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;      kmm1   = km - 1</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;      kmm2   = km - 2</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;      lcap   = km</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;      lcapp1 = lcap + 1</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;      <span class="keywordflow">IF</span> ( nmtvr .eq. 14) <span class="keywordflow">then</span> </div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="comment">! ----  for lm and gwd calculation points</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        rdxzb(:)  = 0 </div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        ipt = 0</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        npt = 0</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        <span class="keywordflow">DO</span> i = 1,im</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;          <span class="keywordflow">IF</span> ( (elvmax(i) .GT. hminmt) </div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;     &amp;       .and. (hprime(i) .GT. hpmin) )  <span class="keywordflow">then</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;             npt      = npt + 1</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;             ipt(npt) = i</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;             <span class="keywordflow">if</span> (ipr .eq. i) npr = npt</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;<span class="keywordflow">          ENDIF</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        <span class="keywordflow">IF</span> (npt .eq. 0) <span class="keywordflow">RETURN</span>     <span class="comment">! No gwd/mb calculation done!</span></div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="comment">!       if (lprnt) print *,&#39; npt=&#39;,npt,&#39; npr=&#39;,npr,&#39; ipr=&#39;,ipr,&#39; im=&#39;,im</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;<span class="comment">!    &amp;,&#39; ipt(npt)=&#39;,ipt(npt)</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;<span class="comment">! --- iwklm is the level above the height of the of the mountain.</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="comment">! --- idxzb is the level of the dividing streamline.</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="comment">! INITIALIZE DIVIDING STREAMLINE (DS) CONTROL VECTOR</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        <span class="keywordflow">do</span> i=1,npt</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;          iwklm(i)  = 2</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;          idxzb(i)  = 0 </div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;          kreflm(i) = 0</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="comment">!       if (lprnt) </span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;<span class="comment">!    &amp;  print *,&#39; in gwdps_lm.f npt,IM,IX,IY,km,me=&#39;,npt,IM,IX,IY,km,me</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="comment">!..............................</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="comment">!..............................</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="comment">!  (*j*)  11/03:  test upper limit on KMLL=km - 1</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="comment">!      then do not need hncrit -- test with large hncrit first.</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="comment">!       KMLL  = km / 2 ! maximum mtnlm height : # of vertical levels / 2</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        kmll = kmm1</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;<span class="comment">! --- No mtn should be as high as KMLL (so we do not have to start at </span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="comment">! --- the top of the model but could do calc for all levels).</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;          <span class="keywordflow">DO</span> i = 1, npt</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;            j = ipt(i)</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;            elvmax(j) = min(elvmax(j) + sigfac * hprime(j), hncrit)</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="keywordflow">          ENDDO</span></div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        <span class="keywordflow">DO</span> k = 1,kmll</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;          <span class="keywordflow">DO</span> i = 1, npt</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;            j = ipt(i)</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="comment">! --- interpolate to max mtn height for index, iwklm(I) wk[gz]</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;<span class="comment">! --- ELVMAX is limited to hncrit because to hi res topo30 orog.</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;            pkp1log =  phil(j,k+1) / g</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;            pklog =  phil(j,k)   / g</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;<span class="comment">!!!-------     ELVMAX(J) = min (ELVMAX(J) + sigfac * hprime(j), hncrit)</span></div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;            <span class="keywordflow">if</span> ( ( elvmax(j) .le.  pkp1log ) .and. </div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;     &amp;           ( elvmax(j) .ge.   pklog  ) ) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;<span class="comment">!     print *,&#39; in gwdps_lm.f 1  =&#39;,k,ELVMAX(j),pklog,pkp1log,me</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="comment">! ---        wk for diags but can be saved and reused.  </span></div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;               wk(i)  = g * elvmax(j) / ( phil(j,k+1) - phil(j,k) )</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;               iwklm(i)  =  max(iwklm(i), k+1 ) </div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="comment">!     print *,&#39; in gwdps_lm.f 2 npt=&#39;,npt,i,j,wk(i),iwklm(i),me</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="comment">! ---        find at prsl levels large scale environment variables</span></div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;<span class="comment">! ---        these cover all possible mtn max heights</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;            vtj(i,k)  = t1(j,k)  * (1.+fv*q1(j,k))</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;            vtk(i,k)  = vtj(i,k) / prslk(j,k)</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;            ro(i,k)   = rdi * prsl(j,k) / vtj(i,k) <span class="comment">! DENSITY Kg/M**3</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;<span class="keywordflow">          ENDDO</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="comment">! testing for highest model level of mountain top</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="comment">!         ihit = 2</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;<span class="comment">!         jhit = 0</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="comment">!        do i = 1, npt</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;<span class="comment">!        j=ipt(i)</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="comment">!          if ( iwklm(i) .gt. ihit ) then </span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<span class="comment">!            ihit = iwklm(i)</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="comment">!            jhit = j</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="comment">!          endif</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="comment">!        enddo</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="comment">!     print *, &#39; mb: kdt,max(iwklm),jhit,phil,me=&#39;,</span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="comment">!    &amp;          kdt,ihit,jhit,phil(jhit,ihit),me</span></div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;         </div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        klevm1 = kmll - 1</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        <span class="keywordflow">DO</span> k = 1, klevm1  </div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;          <span class="keywordflow">DO</span> i = 1, npt</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;           j   = ipt(i)</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;            rdz  = g   / ( phil(j,k+1) - phil(j,k) )</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;<span class="comment">! ---                               Brunt-Vaisala Frequency</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;            bnv2lm(i,k) = (g+g) * rdz * ( vtk(i,k+1)-vtk(i,k) )</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;     &amp;                     / ( vtk(i,k+1)+vtk(i,k) )</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;            bnv2lm(i,k) = max( bnv2lm(i,k), bnv2min )</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="keywordflow">          ENDDO</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="comment">!    print *,&#39; in gwdps_lm.f 3 npt=&#39;,npt,j,RDZ,me</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        <span class="keywordflow">DO</span> i = 1, npt</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;          j   = ipt(i)</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;          delks(i)  = 1.0 / (prsi(j,1) - prsi(j,iwklm(i)))</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;          delks1(i) = 1.0 / (prsl(j,1) - prsl(j,iwklm(i)))</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;          ubar(i)  = 0.0</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;          vbar(i)  = 0.0</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;          roll(i)  = 0.0</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;          pe(i)  = 0.0</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;          ek(i)  = 0.0</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;          bnv2bar(i) = (prsl(j,1)-prsl(j,2)) * delks1(i) * bnv2lm(i,1)</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="comment">! --- find the dividing stream line height </span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="comment">! --- starting from the level above the max mtn downward</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="comment">! --- iwklm(i) is the k-index of mtn elvmax elevation</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;        <span class="keywordflow">DO</span> ktrial = kmll, 1, -1</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;          <span class="keywordflow">DO</span> i = 1, npt</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;             <span class="keywordflow">IF</span> ( ktrial .LT. iwklm(i) .and. kreflm(i) .eq. 0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;                kreflm(i) = ktrial</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;<span class="keywordflow">             ENDIF</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="keywordflow">          ENDDO</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="comment">!     print *,&#39; in gwdps_lm.f 4 npt=&#39;,npt,kreflm(npt),me</span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="comment">! --- in the layer kreflm(I) to 1 find PE (which needs N, ELVMAX)</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="comment">! ---  make averages, guess dividing stream (DS) line layer.</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="comment">! ---  This is not used in the first cut except for testing and</span></div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="comment">! --- is the vert ave of quantities from the surface to mtn top.</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="comment">!   </span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        <span class="keywordflow">DO</span> i = 1, npt</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;          <span class="keywordflow">DO</span> k = 1, kreflm(i)</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;            j        = ipt(i)</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;            rdelks     = del(j,k) * delks(i)</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;            ubar(i)    = ubar(i)  + rdelks * u1(j,k) <span class="comment">! trial Mean U below </span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;            vbar(i)    = vbar(i)  + rdelks * v1(j,k) <span class="comment">! trial Mean V below </span></div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;            roll(i)    = roll(i)  + rdelks * ro(i,k) <span class="comment">! trial Mean RO below </span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;            rdelks     = (prsl(j,k)-prsl(j,k+1)) * delks1(i)</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;            bnv2bar(i) = bnv2bar(i) + bnv2lm(i,k) * rdelks</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="comment">! --- these vert ave are for diags, testing and GWD to follow (*j*).</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="keywordflow">          ENDDO</span></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="comment">!     print *,&#39; in gwdps_lm.f 5  =&#39;,i,kreflm(npt),BNV2bar(npt),me</span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="comment">! --- integrate to get PE in the trial layer.</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;<span class="comment">! --- Need the first layer where PE&gt;EK - as soon as </span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="comment">! --- IDXZB is not 0 we have a hit and Zb is found.</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        <span class="keywordflow">DO</span> i = 1, npt</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;          j = ipt(i)</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;          <span class="keywordflow">DO</span> k = iwklm(i), 1, -1</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;            phiang   =  atan2(v1(j,k),u1(j,k))*rad_to_deg</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;            ang(i,k) = ( theta(j) - phiang )</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;            <span class="keywordflow">if</span> ( ang(i,k) .gt.  90. ) ang(i,k) = ang(i,k) - 180.</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;            <span class="keywordflow">if</span> ( ang(i,k) .lt. -90. ) ang(i,k) = ang(i,k) + 180.</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;            ang(i,k) = ang(i,k) * deg_to_rad</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;            uds(i,k) = </div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;     &amp;          max(sqrt(u1(j,k)*u1(j,k) + v1(j,k)*v1(j,k)), minwnd)</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;<span class="comment">! --- Test to see if we found Zb previously</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;            <span class="keywordflow">IF</span> (idxzb(i) .eq. 0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;              pe(i) = pe(i) + bnv2lm(i,k) * </div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;     &amp;           ( g * elvmax(j) - phil(j,k) ) * </div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;     &amp;           ( phii(j,k+1) - phii(j,k) ) / (g*g)</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="comment">! --- KE</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;<span class="comment">! --- Wind projected on the line perpendicular to mtn range, U(Zb(K)).</span></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="comment">! --- kenetic energy is at the layer Zb</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;<span class="comment">! --- THETA ranges from -+90deg |_ to the mtn &quot;largest topo variations&quot;</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;              up(i)  =  uds(i,k) * cos(ang(i,k))</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;              ek(i)  = 0.5 *  up(i) * up(i) </div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="comment">! --- Dividing Stream lime  is found when PE =exceeds EK.</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;              <span class="keywordflow">IF</span> ( pe(i) .ge.  ek(i) ) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                 idxzb(i) = k</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                 rdxzb(j) = <span class="keywordtype">real</span>(k,kind=kind_phys)</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="keywordflow">              ENDIF</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;<span class="comment">! --- Then mtn blocked flow is between Zb=k(IDXZB(I)) and surface</span></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;<span class="keywordflow">            ENDIF</span></div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;<span class="keywordflow">          ENDDO</span></div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="comment">!     print *,&#39; in gwdps_lm.f 6  =&#39;,phiang,THETA(ipt(npt)),me</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;<span class="comment">!     print *,&#39; in gwdps_lm.f 7  =&#39;,IDXZB(npt),PE(npt)</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;<span class="comment">!     if (lprnt .and. npr .gt. 0) then</span></div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;<span class="comment">!       print *,&#39; BNV2bar,BNV2lm=&#39;,bnv2bar(npr),BNV2lm(npr,1:klevm1)</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;<span class="comment">!       print *,&#39; npr,IDXZB,UDS=&#39;,npr,IDXZB(npr),UDS(npr,:)</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="comment">!       print *,&#39; PE,UP,EK=&#39;,PE(npr),UP(npr),EK(npr)</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="comment">!     endif</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;        <span class="keywordflow">DO</span> i = 1, npt</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;          j    = ipt(i)</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="comment">! --- Calc if N constant in layers (Zb guess) - a diagnostic only.</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;          zbk(i) = elvmax(j)</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;     &amp;           - sqrt(ubar(i)*ubar(i) + vbar(i)*vbar(i))/bnv2bar(i)</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;<span class="comment">!     if (lprnt .and. npr .gt. 0) then</span></div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="comment">!       print *,&#39; iwklm,ZBK=&#39;,iwklm(npr),ZBK(npr),IDXZB(npr)</span></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;<span class="comment">!       print *,&#39; Zb=&#39;,PHIL(ipr),IDXZB(npr))/G</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;<span class="comment">!     print *,&#39; in gwdps_lm.f 8 npt =&#39;,npt,ZBK(npt),UP(npt),me</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="comment">!     endif</span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;<span class="comment">! --- The drag for mtn blocked flow</span></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;<span class="comment">! </span></div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        <span class="keywordflow">DO</span> i = 1, npt</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;          j = ipt(i)</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;          zlen = 0.</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="comment">!      print *,&#39; in gwdps_lm.f 9  =&#39;,i,j,IDXZB(i),me</span></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;          <span class="keywordflow">IF</span> ( idxzb(i) .gt. 0 ) <span class="keywordflow">then</span> </div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;            <span class="keywordflow">DO</span> k = idxzb(i), 1, -1</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;              <span class="keywordflow">IF</span> ( phil(j,idxzb(i)) .gt.  phil(j,k) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;                zlen = sqrt( ( phil(j,idxzb(i)) - phil(j,k) ) / </div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;     &amp;                       ( phil(j,k ) + g * hprime(j) ) )</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="comment">! --- lm eq 14:</span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;                r = (cos(ang(i,k))**2 + gamma(j) * sin(ang(i,k))**2) / </div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;     &amp;              (gamma(j) * cos(ang(i,k))**2 + sin(ang(i,k))**2)</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="comment">! --- (negitive of DB -- see sign at tendency)</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                dbtmp = 0.25 *  cdmb *</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;     &amp;                  max( 2. - 1. / r, 0. ) * sigma(j) *</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;     &amp;                  max(cos(ang(i,k)), gamma(j)*sin(ang(i,k))) *</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;     &amp;                  zlen / hprime(j) </div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                db(i,k) =  dbtmp * uds(i,k)    </div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="comment">!               if(lprnt .and. i .eq. npr) then </span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="comment">!                 print *,&#39; in gwdps_lmi.f 10 npt=&#39;,npt,i,j,idxzb(i)</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;<span class="comment">!    &amp;,           DBTMP,R&#39; ang=&#39;,ang(i,k),&#39; gamma=&#39;,gamma(j),&#39; K=&#39;,K</span></div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;<span class="comment">!                 print *,&#39; in gwdps_lmi.f 11   K=&#39;,k,ZLEN,cos(ANG(I,K))</span></div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="comment">!                 print *,&#39; in gwdps_lmi.f 12  DB=&#39;,DB(i,k),sin(ANG(I,K))</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;<span class="comment">!               endif</span></div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;<span class="keywordflow">            ENDDO</span></div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;<span class="comment">!         if(lprnt) print *,&#39; @K=1,ZLEN,DBTMP=&#39;,K,ZLEN,DBTMP</span></div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="comment">! </span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="comment">!.............................</span></div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="comment">!.............................</span></div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="comment">! end  mtn blocking section</span></div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;      <span class="keywordflow">ELSEIF</span> ( nmtvr .ne. 14) <span class="keywordflow">then</span> </div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="comment">! ----  for mb not present and  gwd (nmtvr .ne .14) </span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;        ipt     = 0</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;        npt     = 0</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        <span class="keywordflow">DO</span> i = 1,im</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;          <span class="keywordflow">IF</span> ( hprime(i) .GT. hpmin )  <span class="keywordflow">then</span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;             npt      = npt + 1</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;             ipt(npt) = i</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;             <span class="keywordflow">if</span> (ipr .eq. i) npr = npt</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="keywordflow">          ENDIF</span></div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;        <span class="keywordflow">IF</span> (npt .eq. 0) <span class="keywordflow">RETURN</span>     <span class="comment">! No gwd/mb calculation done!</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;<span class="comment">!       if (lprnt) print *,&#39; NPR=&#39;,npr,&#39; npt=&#39;,npt,&#39; IPR=&#39;,IPR</span></div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="comment">!      &amp;,&#39; ipt(npt)=&#39;,ipt(npt)</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;        <span class="keywordflow">do</span> i=1,npt</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;          idxzb(i) = 0</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;          rdxzb(i) = 0.</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;<span class="keywordflow">      ENDIF</span></div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="comment">!.............................</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="comment">!.............................</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;      kmpbl  = km / 2 <span class="comment">! maximum pbl height : # of vertical levels / 2</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;<span class="comment">!  Scale cleff between IM=384*2 and 192*2 for T126/T170 and T62</span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;      <span class="keywordflow">if</span> (imx .gt. 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;<span class="comment">!       cleff = 1.0E-5 * SQRT(FLOAT(IMX)/384.0) !  this is inverse of CLEFF!</span></div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;<span class="comment">!       cleff = 1.0E-5 * SQRT(FLOAT(IMX)/192.0) !  this is inverse of CLEFF!</span></div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;<span class="comment">!       cleff = 0.5E-5 * SQRT(FLOAT(IMX)/192.0) !  this is inverse of CLEFF!</span></div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;<span class="comment">!       cleff = 1.0E-5 * SQRT(FLOAT(IMX)/192)/float(IMX/192)</span></div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;<span class="comment">!       cleff = 1.0E-5 / SQRT(FLOAT(IMX)/192.0) !  this is inverse of CLEFF!</span></div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        cleff = 0.5e-5 / sqrt(float(imx)/192.0) <span class="comment">!  this is inverse of CLEFF!</span></div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;<span class="comment">! hmhj for ndsl</span></div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="comment">! jw        cleff = 0.1E-5 / SQRT(FLOAT(IMX)/192.0) !  this is inverse of CLEFF!</span></div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="comment">!       cleff = 2.0E-5 * SQRT(FLOAT(IMX)/192.0) !  this is inverse of CLEFF!</span></div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;<span class="comment">!       cleff = 2.5E-5 * SQRT(FLOAT(IMX)/192.0) !  this is inverse of CLEFF!</span></div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;      <span class="keywordflow">if</span> (cdmbgwd(2) &gt;= 0.0) cleff = cleff * cdmbgwd(2)</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;      <span class="keywordflow">DO</span> k = 1,km</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;        <span class="keywordflow">DO</span> i =1,npt</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;          j         = ipt(i)</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;          vtj(i,k)  = t1(j,k)  * (1.+fv*q1(j,k))</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;          vtk(i,k)  = vtj(i,k) / prslk(j,k)</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;          ro(i,k)   = rdi * prsl(j,k) / vtj(i,k) <span class="comment">! DENSITY TONS/M**3</span></div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;          taup(i,k) = 0.0</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;      <span class="keywordflow">DO</span> k = 1,kmm1</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        <span class="keywordflow">DO</span> i =1,npt</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;          j         = ipt(i)</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;          ti        = 2.0 / (t1(j,k)+t1(j,k+1))</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;          tem       = ti  / (prsl(j,k)-prsl(j,k+1))</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;          rdz       = g   / (phil(j,k+1) - phil(j,k))</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;          tem1      = u1(j,k) - u1(j,k+1)</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;          tem2      = v1(j,k) - v1(j,k+1)</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;          dw2       = tem1*tem1 + tem2*tem2</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;          shr2      = max(dw2,dw2min) * rdz * rdz</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;          bvf2      = g*(gocp+rdz*(vtj(i,k+1)-vtj(i,k))) * ti</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;          ri_n(i,k) = max(bvf2/shr2,rimin)   <span class="comment">! Richardson number</span></div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;<span class="comment">!                                              Brunt-Vaisala Frequency</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;<span class="comment">!         TEM       = GR2 * (PRSL(J,K)+PRSL(J,K+1)) * TEM</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;<span class="comment">!         BNV2(I,K) = TEM * (VTK(I,K+1)-VTK(I,K))/(VTK(I,K+1)+VTK(I,K))</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;          bnv2(i,k) = (g+g) * rdz * (vtk(i,k+1)-vtk(i,k))</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;     &amp;                            / (vtk(i,k+1)+vtk(i,k))</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;          bnv2(i,k) = max( bnv2(i,k), bnv2min )</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;<span class="comment">!      print *,&#39; in gwdps_lm.f GWD:14  =&#39;,npt,kmm1,bnv2(npt,kmm1)</span></div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="comment">!     Apply 3 point smoothing on BNV2</span></div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;<span class="comment">!     do k=1,km</span></div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;<span class="comment">!       do i=1,im</span></div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;<span class="comment">!         vtk(i,k) = bnv2(i,k)</span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;<span class="comment">!       enddo</span></div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;<span class="comment">!     enddo</span></div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;<span class="comment">!     do k=2,kmm1</span></div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;<span class="comment">!       do i=1,im</span></div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;<span class="comment">!         bnv2(i,k) = 0.25*(vtk(i,k-1)+vtk(i,k+1)) + 0.5*vtk(i,k)</span></div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;<span class="comment">!       enddo</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;<span class="comment">!     enddo</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;<span class="comment">!     Finding the first interface index above 50 hPa level</span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;      <span class="keywordflow">do</span> i=1,npt</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;        iwk(i) = 2</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;      <span class="keywordflow">DO</span> k=3,kmpbl</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        <span class="keywordflow">DO</span> i=1,npt</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;          j   = ipt(i)</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;          tem = (prsi(j,1) - prsi(j,k))</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;          <span class="keywordflow">if</span> (tem .lt. dpmin) iwk(i) = k</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;      kbps = 1</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;      kmps = km</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;      <span class="keywordflow">DO</span> i=1,npt</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;        j         = ipt(i)</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        kref(i)   = max(iwk(i), kpbl(j)+1 ) <span class="comment">! reference level </span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;        delks(i)  = 1.0 / (prsi(j,1) - prsi(j,kref(i)))</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        delks1(i) = 1.0 / (prsl(j,1) - prsl(j,kref(i)))</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        ubar(i)  = 0.0</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        vbar(i)  = 0.0</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        roll(i)  = 0.0</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;        kbps      = max(kbps,  kref(i))</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        kmps      = min(kmps,  kref(i))</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;        bnv2bar(i) = (prsl(j,1)-prsl(j,2)) * delks1(i) * bnv2(i,1)</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;<span class="comment">!      print *,&#39; in gwdps_lm.f GWD:15  =&#39;,KBPS,KMPS</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;      kbpsp1 = kbps + 1</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;      kbpsm1 = kbps - 1</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;      <span class="keywordflow">DO</span> k = 1,kbps</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        <span class="keywordflow">DO</span> i = 1,npt</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;          <span class="keywordflow">IF</span> (k .LT. kref(i)) <span class="keywordflow">THEN</span></div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;            j          = ipt(i)</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;            rdelks     = del(j,k) * delks(i)</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;            ubar(i)    = ubar(i)  + rdelks * u1(j,k)   <span class="comment">! Mean U below kref</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;            vbar(i)    = vbar(i)  + rdelks * v1(j,k)   <span class="comment">! Mean V below kref</span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;            roll(i)    = roll(i)  + rdelks * ro(i,k)   <span class="comment">! Mean RO below kref</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;            rdelks     = (prsl(j,k)-prsl(j,k+1)) * delks1(i)</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;            bnv2bar(i) = bnv2bar(i) + bnv2(i,k) * rdelks</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;<span class="keywordflow">          ENDIF</span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;<span class="comment">!      print *,&#39; in gwdps_lm.f GWD:15B =&#39;,bnv2bar(npt)</span></div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="comment">!     FIGURE OUT LOW-LEVEL HORIZONTAL WIND DIRECTION AND FIND &#39;OA&#39;</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="comment">!             NWD  1   2   3   4   5   6   7   8</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;<span class="comment">!              WD  W   S  SW  NW   E   N  NE  SE</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;      <span class="keywordflow">DO</span> i = 1,npt</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;        j      = ipt(i)</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;        wdir   = atan2(ubar(i),vbar(i)) + pi</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        idir   = mod(nint(fdir*wdir),mdir) + 1</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;        nwd    = nwdir(idir)</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;        oa(i)  = (1-2*int( (nwd-1)/4 )) * oa4(j,mod(nwd-1,4)+1)</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        clx(i) = clx4(j,mod(nwd-1,4)+1)</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;<span class="comment">!-----XN,YN            &quot;LOW-LEVEL&quot; WIND PROJECTIONS IN ZONAL</span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;<span class="comment">!                                    &amp; MERIDIONAL DIRECTIONS</span></div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;<span class="comment">!-----ULOW             &quot;LOW-LEVEL&quot; WIND MAGNITUDE -        (= U)</span></div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;<span class="comment">!-----BNV2             BNV2 = N**2</span></div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;<span class="comment">!-----TAUB             BASE MOMENTUM FLUX</span></div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;<span class="comment">!-----= -(RO * U**3/(N*XL)*GF(FR) FOR N**2 &gt; 0</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;<span class="comment">!-----= 0.                        FOR N**2 &lt; 0</span></div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;<span class="comment">!-----FR               FROUDE    =   N*HPRIME / U</span></div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;<span class="comment">!-----G                GMAX*FR**2/(FR**2+CG/OC)</span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;<span class="comment">!-----INITIALIZE SOME ARRAYS</span></div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;      <span class="keywordflow">DO</span> i = 1,npt</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        xn(i)     = 0.0</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;        yn(i)     = 0.0</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;        taub(i)  = 0.0</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        ulow(i)  = 0.0</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        dtfac(i)  = 1.0</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;        icrilv(i) = .false. <span class="comment">! INITIALIZE CRITICAL LEVEL CONTROL VECTOR</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;        </div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;<span class="comment">!----COMPUTE THE &quot;LOW LEVEL&quot; WIND MAGNITUDE (M/S)</span></div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;        ulow(i) = max(sqrt(ubar(i)*ubar(i) + vbar(i)*vbar(i)), 1.0)</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;        uloi(i) = 1.0 / ulow(i)</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;      <span class="keywordflow">DO</span>  k = 1,kmm1</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        <span class="keywordflow">DO</span>  i = 1,npt</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;          j            = ipt(i)</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;          velco(i,k)   = 0.5 * ((u1(j,k)+u1(j,k+1))*ubar(i)</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;     &amp;                       +  (v1(j,k)+v1(j,k+1))*vbar(i))</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;          velco(i,k)   = velco(i,k) * uloi(i)</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="comment">!         IF ((VELCO(I,K).LT.VELEPS) .AND. (VELCO(I,K).GT.0.)) THEN</span></div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="comment">!           VELCO(I,K) = VELEPS</span></div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;<span class="comment">!         ENDIF</span></div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="comment">!      </span></div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="comment">!   find the interface level of the projected wind where</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;<span class="comment">!   low levels &amp; upper levels meet above pbl</span></div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;<span class="comment">!     do i=1,npt</span></div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;<span class="comment">!       kint(i) = km</span></div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;<span class="comment">!     enddo</span></div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;<span class="comment">!     do k = 1,kmm1</span></div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="comment">!       do i = 1,npt</span></div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;<span class="comment">!         IF (K .GT. kref(I)) THEN</span></div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;<span class="comment">!           if(velco(i,k) .lt. veleps .and. kint(i) .eq. km) then</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;<span class="comment">!             kint(i) = k+1</span></div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;<span class="comment">!           endif</span></div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;<span class="comment">!         endif</span></div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;<span class="comment">!       enddo</span></div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;<span class="comment">!     enddo</span></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;<span class="comment">!  WARNING  KINT = KREF !!!!!!!!!</span></div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;      <span class="keywordflow">do</span> i=1,npt</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        kint(i) = kref(i)</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;<span class="comment">!     if(lprnt) print *,&#39; ubar=&#39;,ubar</span></div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;<span class="comment">!    &amp;,&#39; vbar=&#39;,vbar,&#39; ulow=&#39;,ulow,&#39; veleps=&#39;,veleps</span></div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;      <span class="keywordflow">DO</span> i = 1,npt</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        j      = ipt(i)</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;        bnv    = sqrt( bnv2bar(i) )</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;        fr     = bnv     * uloi(i) * min(hprime(j),hpmax)</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;        fr     = min(fr, frmax)</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;        xn(i)  = ubar(i) * uloi(i)</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;        yn(i)  = vbar(i) * uloi(i)</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;<span class="comment">!     Compute the base level stress and store it in TAUB</span></div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;<span class="comment">!     CALCULATE ENHANCEMENT FACTOR, NUMBER OF MOUNTAINS &amp; ASPECT</span></div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="comment">!     RATIO CONST. USE SIMPLIFIED RELATIONSHIP BETWEEN STANDARD</span></div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;<span class="comment">!     DEVIATION &amp; CRITICAL HGT</span></div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        efact    = (oa(i) + 2.) ** (ceofrc*fr)</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        efact    = min( max(efact,efmin), efmax )</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;        coefm    = (1. + clx(i)) ** (oa(i)+1.)</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        xlinv(i) = coefm * cleff</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;        tem      = fr    * fr * oc(j)</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;        gfobnv   = gmax  * tem / ((tem + cg)*bnv)  <span class="comment">! G/N0</span></div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;        taub(i)  = xlinv(i) * roll(i) * ulow(i) * ulow(i)</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;     &amp;           * ulow(i)  * gfobnv  * efact         <span class="comment">! BASE FLUX Tau0</span></div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;<span class="comment">!         tem      = min(HPRIME(I),hpmax)</span></div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;<span class="comment">!         TAUB(I)  = XLINV(I) * ROLL(I) * ULOW(I) * BNV * tem * tem</span></div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;        k        = max(1, kref(i)-1)</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;        tem      = max(velco(i,k)*velco(i,k), 0.1)</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;        scor(i)  = bnv2(i,k) / tem  <span class="comment">! Scorer parameter below ref level</span></div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;<span class="comment">!     if(lprnt) print *,&#39; taub=&#39;,taub</span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;<span class="comment">!                                                                       </span></div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;<span class="comment">!----SET UP BOTTOM VALUES OF STRESS</span></div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;      <span class="keywordflow">DO</span> k = 1, kbps</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        <span class="keywordflow">DO</span> i = 1,npt</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;          <span class="keywordflow">IF</span> (k .LE. kref(i)) taup(i,k) = taub(i)</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;<span class="comment">!   Now compute vertical structure of the stress.</span></div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;      <span class="keywordflow">DO</span> k = kmps, kmm1                   <span class="comment">! Vertical Level K Loop!</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;        kp1 = k + 1</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        <span class="keywordflow">DO</span> i = 1, npt</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;<span class="comment">!-----UNSTABLE LAYER IF RI &lt; RIC</span></div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;<span class="comment">!-----UNSTABLE LAYER IF UPPER AIR VEL COMP ALONG SURF VEL &lt;=0 (CRIT LAY)</span></div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;<span class="comment">!---- AT (U-C)=0. CRIT LAYER EXISTS AND BIT VECTOR SHOULD BE SET (.LE.)</span></div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;          <span class="keywordflow">IF</span> (k .GE. kref(i)) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;            icrilv(i) = icrilv(i) .OR. ( ri_n(i,k) .LT. ric)</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;     &amp;                            .OR. (velco(i,k) .LE. 0.0)</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;<span class="keywordflow">          ENDIF</span></div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;        <span class="keywordflow">DO</span> i = 1,npt</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;          <span class="keywordflow">IF</span> (k .GE. kref(i))   <span class="keywordflow">THEN</span></div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;            <span class="keywordflow">IF</span> (.NOT.icrilv(i) .AND. taup(i,k) .GT. 0.0 ) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;              temv = 1.0 / max(velco(i,k), 0.01)</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;<span class="comment">!             IF (OA(I) .GT. 0. .AND.  PRSI(ipt(i),KP1).GT.RLOLEV) THEN</span></div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;              <span class="keywordflow">IF</span> (oa(i).GT.0. .AND. kp1 .lt. kint(i)) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;                scork   = bnv2(i,k) * temv * temv</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;                rscor   = min(1.0, scork / scor(i))</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;                scor(i) = scork</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;              <span class="keywordflow">ELSE</span> </div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;                rscor   = 1.</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;<span class="keywordflow">              ENDIF</span></div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;              brvf = sqrt(bnv2(i,k))        <span class="comment">! Brunt-Vaisala Frequency</span></div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;<span class="comment">!             TEM1 = XLINV(I)*(RO(I,KP1)+RO(I,K))*BRVF*VELCO(I,K)*0.5</span></div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;              tem1 = xlinv(i)*(ro(i,kp1)+ro(i,k))*brvf*0.5</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;     &amp;                       * max(velco(i,k),0.01)</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;              hd   = sqrt(taup(i,k) / tem1)</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;              fro  = brvf * hd * temv</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;<span class="comment">!    RIM is the  MINIMUM-RICHARDSON NUMBER BY SHUTTS (1985)</span></div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;              tem2   = sqrt(ri_n(i,k))</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;              tem    = 1. + tem2 * fro</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;              rim    = ri_n(i,k) * (1.-fro) / (tem * tem)</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;<span class="comment">!    CHECK STABILITY TO EMPLOY THE &#39;SATURATION HYPOTHESIS&#39;</span></div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;<span class="comment">!    OF LINDZEN (1981) EXCEPT AT TROPOSPHERIC DOWNSTREAM REGIONS</span></div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;<span class="comment">!                                       ----------------------</span></div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;              <span class="keywordflow">IF</span> (rim .LE. ric .AND.</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;<span class="comment">!    &amp;           (OA(I) .LE. 0. .OR.  PRSI(ipt(I),KP1).LE.RLOLEV )) THEN</span></div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;     &amp;           (oa(i) .LE. 0. .OR.  kp1 .ge. kint(i) )) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;                 temc = 2.0 + 1.0 / tem2</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;                 hd   = velco(i,k) * (2.*sqrt(temc)-temc) / brvf</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;                 taup(i,kp1) = tem1 * hd * hd</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;              <span class="keywordflow">ELSE</span> </div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;                 taup(i,kp1) = taup(i,k) * rscor</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;<span class="keywordflow">              ENDIF</span></div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;              taup(i,kp1) = min(taup(i,kp1), taup(i,k))</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;<span class="keywordflow">            ENDIF</span></div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;<span class="keywordflow">          ENDIF</span></div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;<span class="comment">!     DO I=1,IM</span></div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;<span class="comment">!       taup(i,km+1) = taup(i,km)</span></div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;<span class="comment">!     ENDDO</span></div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;      <span class="keywordflow">IF</span>(lcap .LE. km) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;         <span class="keywordflow">DO</span> klcap = lcapp1, km+1</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;            <span class="keywordflow">DO</span> i = 1,npt</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;              sira          = prsi(ipt(i),klcap) / prsi(ipt(i),lcap)</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;              taup(i,klcap) = sira * taup(i,lcap)</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;<span class="keywordflow">            ENDDO</span></div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;<span class="keywordflow">         ENDDO</span></div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;<span class="keywordflow">      ENDIF</span></div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;<span class="comment">!     Calculate - (g/p*)*d(tau)/d(sigma) and Decel terms DTAUX, DTAUY</span></div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;      <span class="keywordflow">DO</span> k = 1,km</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;        <span class="keywordflow">DO</span> i = 1,npt</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;          taud(i,k) = g * (taup(i,k+1) - taup(i,k)) / del(ipt(i),k)</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;<span class="comment">!------LIMIT DE-ACCELERATION (MOMENTUM DEPOSITION ) AT TOP TO 1/2 VALUE</span></div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;<span class="comment">!------THE IDEA IS SOME STUFF MUST GO OUT THE &#39;TOP&#39;</span></div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;      <span class="keywordflow">DO</span> klcap = lcap, km</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;         <span class="keywordflow">DO</span> i = 1,npt</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;            taud(i,klcap) = taud(i,klcap) * factop</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;<span class="keywordflow">         ENDDO</span></div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;<span class="comment">!------IF THE GRAVITY WAVE DRAG WOULD FORCE A CRITICAL LINE IN THE</span></div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;<span class="comment">!------LAYERS BELOW SIGMA=RLOLEV DURING THE NEXT DELTIM TIMESTEP,</span></div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;<span class="comment">!------THEN ONLY APPLY DRAG UNTIL THAT CRITICAL LINE IS REACHED.</span></div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;      <span class="keywordflow">DO</span> k = 1,kmm1</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;        <span class="keywordflow">DO</span> i = 1,npt</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;           <span class="keywordflow">IF</span> (k .GT. kref(i) .and. prsi(ipt(i),k) .GE. rlolev) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;             <span class="keywordflow">IF</span>(taud(i,k).NE.0.) <span class="keywordflow">THEN</span></div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;               tem = deltim * taud(i,k)</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;               dtfac(i) = min(dtfac(i),abs(velco(i,k)/tem))</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;<span class="keywordflow">             ENDIF</span></div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;<span class="keywordflow">           ENDIF</span></div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;<span class="comment">!     if(lprnt .and. npr .gt. 0) then</span></div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;<span class="comment">!       print *,&#39; before  A=&#39;,A(npr,:)</span></div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;<span class="comment">!       print *,&#39; before  B=&#39;,B(npr,:)</span></div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;<span class="comment">!     endif</span></div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;      <span class="keywordflow">DO</span> k = 1,km</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;        <span class="keywordflow">DO</span> i = 1,npt</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;          j          = ipt(i)</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;          taud(i,k)  = taud(i,k) * dtfac(i)</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;          dtaux      = taud(i,k) * xn(i)</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;          dtauy      = taud(i,k) * yn(i)</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;          eng0       = 0.5*(u1(j,k)*u1(j,k)+v1(j,k)*v1(j,k))</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;<span class="comment">! ---  lm mb (*j*)  changes overwrite GWD</span></div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;          <span class="keywordflow">if</span> ( k .lt. idxzb(i) .AND. idxzb(i) .ne. 0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;            dbim = db(i,k) / (1.+db(i,k)*deltim)</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;            a(j,k)  = - dbim * v1(j,k) + a(j,k)</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;            b(j,k)  = - dbim * u1(j,k) + b(j,k)</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;            eng1    = eng0*(1.0-dbim*deltim)*(1.0-dbim*deltim)</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;<span class="comment">!          if ( ABS(DBIM * U1(J,K)) .gt. .01 ) </span></div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;<span class="comment">!    &amp; print *,&#39; in gwdps_lmi.f KDT=&#39;,KDT,I,K,DB(I,K),</span></div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;<span class="comment">!    &amp;                      dbim,idxzb(I),U1(J,K),V1(J,K),me</span></div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;            dusfc(j)   = dusfc(j) - dbim * u1(j,k) * del(j,k)</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;            dvsfc(j)   = dvsfc(j) - dbim * v1(j,k) * del(j,k)</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;            a(j,k)     = dtauy     + a(j,k)</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;            b(j,k)     = dtaux     + b(j,k)</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;            eng1       = 0.5*(</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;     &amp;                   (u1(j,k)+dtaux*deltim)*(u1(j,k)+dtaux*deltim)</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;     &amp;                 + (v1(j,k)+dtauy*deltim)*(v1(j,k)+dtauy*deltim))</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;            dusfc(j)   = dusfc(j)  + dtaux * del(j,k)</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;            dvsfc(j)   = dvsfc(j)  + dtauy * del(j,k)</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;          c(j,k) = c(j,k) + max(eng0-eng1,0.)/cp/deltim</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;<span class="keywordflow">        ENDDO</span></div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;<span class="comment">!     if (lprnt) then</span></div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;<span class="comment">!       print *,&#39; in gwdps_lm.f after  A=&#39;,A(ipr,:)</span></div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;<span class="comment">!       print *,&#39; in gwdps_lm.f after  B=&#39;,B(ipr,:)</span></div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;<span class="comment">!       print *,&#39; DB=&#39;,DB(ipr,:)</span></div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;<span class="comment">!     endif</span></div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;      tem    = -1.0/g</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;      <span class="keywordflow">DO</span> i = 1,npt</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;        j          = ipt(i)</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;<span class="comment">!       TEM    = (-1.E3/G)</span></div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;        dusfc(j) = tem * dusfc(j)</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;        dvsfc(j) = tem * dvsfc(j)</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;<span class="keywordflow">      ENDDO</span></div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;<span class="comment">!                                                                       </span></div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;<span class="comment">!    MONITOR FOR EXCESSIVE GRAVITY WAVE DRAG TENDENCIES IF NCNT&gt;0</span></div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;<span class="comment">!     IF(NCNT.GT.0) THEN</span></div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;<span class="comment">!        IF(LAT.GE.38.AND.LAT.LE.42) THEN</span></div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;<span class="comment">!CMIC$ GUARD 37</span></div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;<span class="comment">!           DO 92 I = 1,IM</span></div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;<span class="comment">!              IF(IKOUNT.GT.NCNT) GO TO 92</span></div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;<span class="comment">!              IF(I.LT.319.OR.I.GT.320) GO TO 92</span></div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;<span class="comment">!              DO 91 K = 1,KM</span></div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;<span class="comment">!                 IF(ABS(TAUD(I,K)) .GT. CRITAC) THEN</span></div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;<span class="comment">!                    IF(I.LE.IM) THEN</span></div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;<span class="comment">!                       IKOUNT = IKOUNT+1</span></div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;<span class="comment">!                       PRINT 123,I,LAT,KDT</span></div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;<span class="comment">!                       PRINT 124,TAUB(I),BNV(I),ULOW(I),</span></div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;<span class="comment">!    1                  GF(I),FR(I),ROLL(I),HPRIME(I),XN(I),YN(I)</span></div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;<span class="comment">!                       PRINT 124,(TAUD(I,KK),KK = 1,KM)</span></div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;<span class="comment">!                       PRINT 124,(TAUP(I,KK),KK = 1,KM+1)</span></div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;<span class="comment">!                       PRINT 124,(ri_n(I,KK),KK = 1,KM)</span></div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;<span class="comment">!                       DO 93 KK = 1,KMM1</span></div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;<span class="comment">!                          VELKO(KK) =</span></div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;<span class="comment">!    1                  0.5*((U1(I,KK)+U1(I,KK+1))*UBAR(I)+</span></div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;<span class="comment">!    2                  (V1(I,KK)+V1(I,KK+1))*VBAR(I))*ULOI(I)</span></div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;<span class="comment">!93                     CONTINUE</span></div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;<span class="comment">!                       PRINT 124,(VELKO(KK),KK = 1,KMM1)</span></div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;<span class="comment">!                       PRINT 124,(A    (I,KK),KK = 1,KM)</span></div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;<span class="comment">!                       PRINT 124,(DTAUY(I,KK),KK = 1,KM)</span></div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;<span class="comment">!                       PRINT 124,(B    (I,KK),KK = 1,KM)</span></div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;<span class="comment">!                       PRINT 124,(DTAUX(I,KK),KK = 1,KM)</span></div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;<span class="comment">!                       GO TO 92</span></div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;<span class="comment">!                    ENDIF</span></div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;<span class="comment">!                 ENDIF</span></div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;<span class="comment">!91            CONTINUE</span></div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;<span class="comment">!92         CONTINUE</span></div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;<span class="comment">!CMIC$ END GUARD 37</span></div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;<span class="comment">!123        FORMAT(&#39;  *** MIGWD PRINT *** I=&#39;,I3,&#39; LAT=&#39;,I3,&#39; KDT=&#39;,I3)</span></div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;<span class="comment">!124        FORMAT(2X,  10E13.6)</span></div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;<span class="comment">!        ENDIF</span></div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;<span class="comment">!     ENDIF</span></div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;<span class="comment">!      print *,&#39; in gwdps_lm.f 18  =&#39;,A(ipt(1),idxzb(1))</span></div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;<span class="comment">!    &amp;,                          B(ipt(1),idxzb(1)),me</span></div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;      <span class="keywordflow">RETURN</span></div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;<span class="keyword">      END</span></div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;</div><div class="ttc" id="group___g_f_s__ogwd_html_ga82eda62e1bdee0a0ab6a831fc53ae89c"><div class="ttname"><a href="group___g_f_s__ogwd.html#ga82eda62e1bdee0a0ab6a831fc53ae89c">gwdps</a></div><div class="ttdeci">subroutine gwdps(IM, IX, IY, KM, A, B, C, U1, V1, T1, Q1, KPBL, PRSI, DEL, PRSL, PRSLK, PHII, PHIL, DELTIM, KDT, HPRIME, OC, OA4, CLX4, THETA, SIGMA, GAMMA, ELVMAX, DUSFC, DVSFC, G, CP, RD, RV, IMX, nmtvr, cdmbgwd, me, lprnt, ipr, rdxzb)</div><div class="ttdef"><b>Definition:</b> <a href="gwdps_8f_source.html#l00342">gwdps.f:342</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="gwdps_8f.html">gwdps.f</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
