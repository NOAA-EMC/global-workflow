#!/bin/sh
#PBS -N gfs_gempak_meta_00
#PBS -j oe
#PBS -l place=vscatter,select=4:ncpus=32:mpiprocs=32:mem=5GB
#PBS -q debug
#PBS -l walltime=00:30:00
#PBS -A GFS-DEV
#PBS -V
#PBS -W umask=022

cd $PBS_O_WORKDIR

export PDY=`date -u +%Y%m%d`
 export PDY=20210824
# export PDY=20210922

export PDY1=`expr $PDY - 1`

export cyc=00
export cycle=t${cyc}z

export threads=1
export MP_LABELIO=yes

set -xa
export PS4='$SECONDS + '
date

#############################################################
# Specify Run Driver location
#############################################################
export driver=/lfs/h2/emc/vpppg/noscrub/$USER/packages/gfs.$gfs_ver/driver

#############################################################
# Load module version on WCOSS2
#############################################################
. ${driver}/../versions/run.ver

####################################
##  Load the GRIB Utilities module
#####################################
module load PrgEnv-intel/$PrgEnv_intel_ver
module load craype/$craype_ver
module load intel/$intel_ver
module load cray-mpich/$cray_mpich_ver
module load cray-pals/$cray_pals_ver
module load cfp/$cfp_ver
module load prod_util/${prod_util_ver}
module load prod_envir/${prod_envir_ver}
module load libjpeg/$libjpeg_ver
module load grib_util/$grib_util_ver
module load wgrib2/$wgrib2_ver

##############################################
# Now set up GEMPAK/NTRANS environment
###########################################
module load gempak/$gempak_ver
module list

############################################
# Define COM, COMOUTwmo, COMIN  directories
############################################
# set envir=para or para to test with data in prod or para
export envir=para

export SENDCOM=YES
export KEEPDATA=YES
export job=${job:-$PBS_JOBNAME}
export jobid=${jobid:-$job.$PBS_JOBID}

# Set FAKE DBNET for testing
export SENDDBN=YES
export DBNROOT=/apps/ops/prod/nco/core/prod_util.v${prod_util_ver}/fakedbn

#############################################################
# Specify LOCAL OUTPUT
#############################################################
export DATAROOT=/lfs/h2/emc/ptmp/$USER/output
export PACKAGEROOT=/lfs/h2/emc/vpppg/noscrub/$USER/packages
export COMROOT2=/lfs/h2/emc/ptmp/$USER/output/com
mkdir -m 775 -p ${COMROOT2}

##########################################################
# obtain unique process id (pid) and make temp directory
##########################################################
export DATA=${DATA:-${DATAROOT}/${PBS_JOBNAME}.${PBS_JOBID}}
mkdir -p $DATA
cd $DATA

#############################################
#set the fcst hrs for all the cycles
#############################################
export fhbeg=00
export fhend=384
export fhinc=12

################################
# Set up the HOME directory
################################
export HOMEgfs=${HOMEgfs:-${PACKAGEROOT}/gfs.${gfs_ver}}
export EXECgfs=${EXECgfs:-$HOMEgfs/exec}
export PARMgfs=${PARMgfs:-$HOMEgfs/parm}
export EXPDIR=${EXPDIR:-$HOMEgfs/parm/config}
export FIXgempak=${FIXgempak:-$HOMEgfs/gempak/fix}
export USHgempak=${USHgempak:-$HOMEgfs/gempak/ush}
export SRCgfs=${SRCgfs:-$HOMEgfs/scripts}

###################################
# Specify NET and RUN Name and model
####################################
export NET=${NET:-gfs}
export RUN=${RUN:-gfs}
export model=${model:-gfs}
export COMPONENT=${COMPONENT:-atmos}

##############################################
# Define COM directories
##############################################
if [ $envir = "prod" ] ; then
#  This setting is for testing with GFS (production)
  export COMIN=${COMIN:-$(compath.py ${envir}/${NET}/${gfs_ver})/${RUN}.${PDY}/${cyc}/$COMPONENT}/gempak ### NCO PROD
  export COMINgempak=${COMINgempak:-$(compath.py ${envir}/${NET}/${gfs_ver})}
else
  export COMIN=/lfs/h1/ops/canned/com/gfs/v16.2/${RUN}.20210824/${cyc}/${COMPONENT}/gempak ## canned data
  export COMINgempak=/lfs/h1/ops/canned/com/gfs/v16.2                                      ## canned data
#  export COMIN=/lfs/h2/emc/ptmp/Boi.Vuong/output/com/gfs/para/gfs.20210922/00/atmos/gempak ## BOI canned data
#  export COMINgfs=/lfs/h2/emc/ptmp/Boi.Vuong/output/com/gfs/para                           ## BOI canned data

fi
export COMOUT=${COMROOT2}/${NET}/${gfs_ver}/${RUN}.${PDY}/${cyc}/atmos/gempak/meta

# export ukmet_ver=v2.2.0
export COMINukmet=${COMINukmet:-$(compath.py ${envir}/ukmet/${ukmet_ver})/ukmet}
# export ecmwf_ver=v2.1.0
export COMINecmwf=${COMINecmwf:-$(compath.py ${envir}/ecmwf/${ecmwf_ver})/ecmwf}
# export nam_ver=v4.2.0
export COMINnam=${COMINnam:-$(compath.py ${envir}/nam/${nam_ver})/nam}

if [ ! -f $COMOUT ] ; then
  mkdir -p -m 775 $COMOUT
fi

#############################################
# run the GFS job
#############################################
sh $HOMEgfs/jobs/JGFS_ATMOS_GEMPAK_META
