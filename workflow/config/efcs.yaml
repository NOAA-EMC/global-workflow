# This file is used to generate config.efcs, which would be used to
# control the ENKF forecast jobs.  The scripts and code for the ENKF
# are not provided in this release, so this config file is ignored.

config_efcs:
  filename: config.efcs
  res_interval: !FirstTrue
    - when: !calc doc.fv3_enkf_settings.DOIAU_ENKF=="YES"
      do: 3
    - otherwise: !calc doc.fv3_enkf_settings.restart_interval
  content: !expand |
    #!/bin/ksh -x
    
    # This file is automatically generated from the YAML-based system
    # Any changes will be overwritten if setup_case.sh is rerun.
    
    ########## config.efcs ##########
    # Ensemble forecast specific, dependency: config.fcst
    
    echo "BEGIN: config.efcs"
    
    # Source model specific information that is resolution dependent
    . $EXPDIR/config.fv3 enkf

    export npe_efcs="{doc.partition_common.resources.run_efcs[0].mpi_ranks}"
    export npe_node_efcs="{doc.partition_common.resources.run_efcs[0].max_ppn}"
    export nth_efcs=$nth_fv3
    if [[ "$machine" == "WCOSS_C" ]]; then
        export memory_efcs="254M"
    elif [[ "$machine" == "GAEA" ]]; then
        export memory_efcs="254"
    fi
    
    export ENKFFCSTSH="$HOMEgsi/scripts/exglobal_enkf_fcst_fv3gfs.sh.ecf"
    export NMEM_EFCSGRP={doc.data_assimilation.NMEM_EFCSGRP}
    export RERUN_EFCSGRP="{tools.YES_NO(doc.data_assimilation.RERUN_EFCSGRP)}"
    
    # Stochastic physics parameters (only for ensemble forecasts)
    export DO_SKEB="{tools.YES_NO(doc.fv3_enkf_settings.DO_SKEB)}"
    export SKEB={doc.fv3_enkf_settings.SKEB}
    export SKEB_TAU={doc.fv3_enkf_settings.SKEB_TAU}
    export SKEB_LSCALE={doc.fv3_enkf_settings.SKEB_LSCALE}
    export SKEBNORM={doc.fv3_enkf_settings.SKEBNORM}
    export SKEB_NPASS={doc.fv3_enkf_settings.SKEB_NPASS}
    export SKEB_VDOF={doc.fv3_enkf_settings.SKEB_VDOF}
    export DO_SHUM="{tools.YES_NO(doc.fv3_enkf_settings.DO_SHUM)}"
    export SHUM={doc.fv3_enkf_settings.SHUM}
    export SHUM_TAU={doc.fv3_enkf_settings.SHUM_TAU}
    export SHUM_LSCALE={doc.fv3_enkf_settings.SHUM_LSCALE}
    export DO_SPPT="{tools.YES_NO(doc.fv3_enkf_settings.DO_SPPT)}"
    export SPPT={doc.fv3_enkf_settings.SPPT}
    export SPPT_TAU={doc.fv3_enkf_settings.SPPT_TAU}
    export SPPT_LSCALE={doc.fv3_enkf_settings.SPPT_LSCALE}
    export SPPT_LOGIT="{tools.fort(doc.fv3_enkf_settings.SPPT_LOGIT)}"
    export SPPT_SFCLIMIT="{tools.fort(doc.fv3_enkf_settings.SPPT_SFCLIMIT)}"
    
    if [ $QUILTING = ".true." -a $OUTPUT_GRID = "gaussian_grid" ]; then
        export DIAG_TABLE="$HOMEgfs/parm/parm_fv3diag/diag_table_da"
    else
        export DIAG_TABLE="$HOMEgfs/parm/parm_fv3diag/diag_table_da_orig"
    fi
    
    # FV3 model namelist parameters to over-ride
    export restart_interval={res_interval}

    # For IAU, write restarts at beginning of window also
    # if [ $DOIAU_ENKF = "YES" ]; then export restart_interval=3; fi

    export k_split={doc.fv3_enkf_settings.k_split}  # model is unstable with k_split=2, n_split=6 and stochastic physics
    export n_split={doc.fv3_enkf_settings.n_split} # make the model stable with k_split=1, n_split=12
    
    echo "END: config.efcs"
    
