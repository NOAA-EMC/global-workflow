#! /usr/bin/env bash

###########################################################
# Global Minimization Monitor (MinMon) job
###########################################################
source "${HOMEgfs}/ush/preamble.sh"
source "${HOMEgfs}/ush/jjob_header.sh" -e "vminmon" -c "base vminmon"

##############################################
# Specify Package Areas
##############################################
export M_FIX=${M_FIX:-${HOMEgfs}/fix/mon}
export SCRgfs=${SCRgfs:-${HOMEgfs}/scripts}
export USHminmon=${USHminmon:-${HOMEgfs}/ush}

#############################################
# Determine PDY and cyc for previous cycle
#############################################
pdate=$(${NDATE} -6 ${PDY}${cyc})
export P_PDY=${pdate:0:8}
export p_cyc=${pdate:8:2}

#############################################
# TANKverf - WHERE OUTPUT DATA WILL RESIDE
#############################################
YMD=${PDY} HH=${cyc} generate_com -rx COM_ATMOS_ANALYSIS
YMD=${PDY} HH=${cyc} generate_com -rx COM_ATMOS_MINMON
YMD=${P_PDY} HH=${p_cyc} generate_com -rx COM_ATMOS_MINMON_PREV:COM_ATMOS_MINMON_TMPL

export M_TANKverf=${M_TANKverf:-${COM_ATMOS_MINMON}}
export M_TANKverfM1=${M_TANKverfM1:-${COM_ATMOS_MINMON_PREV}}

if [[ ! -d ${M_TANKverf} ]]; then mkdir -p -m 775 ${M_TANKverf} ; fi
if [[ ! -d ${M_TANKverfM1} ]]; then mkdir -p -m 775 ${M_TANKverfM1} ; fi

########################################
# Set necessary environment variables
########################################
export MINMON_SUFFIX=${MINMON_SUFFIX:-${NET}}
export CYCLE_INTERVAL=6

########################################
#  Filenames
########################################
gsistat=${gsistat:-${COM_ATMOS_ANALYSIS}/${RUN}.t${cyc}z.gsistat}
export mm_gnormfile=${gnormfile:-${M_FIX}/${RUN}_minmon_gnorm.txt}
export mm_costfile=${costfile:-${M_FIX}/${RUN}_minmon_cost.txt}


########################################################
# Execute the script.
${GMONSH:-${SCRgfs}/exglobal_atmos_vminmon.sh} ${PDY} ${cyc}
err=$?
[[ ${err} -ne 0 ]] && exit ${err}


################################
# Remove the Working Directory
################################
[[ "${KEEPDATA}" = "NO" ]] && rm -rf "${DATA}"

exit 0
