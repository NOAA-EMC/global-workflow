#! /usr/bin/env bash

source "${HOMEgfs}/ush/preamble.sh"
source "${HOMEgfs}/ush/jjob_header.sh" -e "stage_ic" -c "base stage_ic"

# Define significant cycles
# shellcheck disable=SC2153
half_window=$(( assim_freq / 2 ))
current_cycle="${PDY}${cyc}"
previous_cycle=$(date --utc -d "${PDY} ${cyc} - ${assim_freq} hours" +%Y%m%d%H)
current_cycle_begin=$(date --utc -d "${PDY} ${cyc} - ${half_window} hours" +%Y%m%d%H)
current_cycle_end=$(date --utc -d "${PDY} ${cyc} + ${half_window} hours" +%Y%m%d%H)

# Define model start date for current_cycle as the time the forecast will start
if [[ "${DOIAU:-NO}" == "YES" ]] && [[ "${MODE}" == "cycled" ]] ; then
  model_start_date_current_cycle="${current_cycle_begin}"
else
  if [[ "${REPLAY_ICS:-NO}" == "YES" ]]; then
    model_start_date_current_cycle=${current_cycle_end}
  else
    model_start_date_current_cycle=${current_cycle}
  fi
fi
export current_cycle previous_cycle model_start_date_current_cycle

# Initialize return code
err=0

# Execute staging
"${SCRgfs}/exglobal_stage_ic.py"

###############################################################
# Check for errors and exit if any of the above failed
if [[ "${err}" -ne 0 ]]; then
  echo "FATAL ERROR: Unable to copy ICs to ${ROTDIR}; ABORT!"
  exit "${err}"
fi

##########################################
# Remove the Temporary working directory
##########################################
cd "${DATAROOT}" || (echo "${DATAROOT} does not exist. ABORT!"; exit 1)
[[ ${KEEPDATA} = "NO" ]] && rm -rf "${DATA}"

exit 0
