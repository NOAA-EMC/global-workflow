{% set cycle_HH = current_cycle | strftime("%H") %}

{% if MODE == "cycled" %}
analysis:
    mkdir:
        - "{{ COMOUT_ATMOS_ANALYSIS }}"
    copy:
        # TODO: Add abias_int?
        {% for ftype in ["abias", "abias_air", "abias_pc", "radstat"] %}
        - ["{{ ICSDIR }}/{{ COMOUT_ATMOS_ANALYSIS | relpath(ROTDIR) }}/{{ RUN }}.t{{ cycle_HH }}z.{{ ftype }}", "{{ COMOUT_ATMOS_ANALYSIS }}"]
        {% endfor %}
{% endif %}

{% if EXP_WARM_START == True %}
atmosphere_warm:
    mkdir:
        - "{{ COMOUT_ATMOS_RESTART_PREV }}"
    copy:
        {% for ftype in ["coupler.res", "fv_core.res.nc"] %}
        - ["{{ ICSDIR }}/{{ COMOUT_ATMOS_RESTART_PREV | relpath(ROTDIR) }}/{{ DTG_PREFIX }}.{{ ftype }}", "{{ COMOUT_ATMOS_RESTART_PREV }}"]
        {% endfor %}
        {% for ftype in ["ca_data", "fv_core.res", "fv_srf_wnd.res", "fv_tracer.res", "phy_data", "sfc_data"] %}
            {% for ntile in range(1, ntiles + 1) %}
        - ["{{ ICSDIR }}/{{ COMOUT_ATMOS_RESTART_PREV | relpath(ROTDIR) }}/{{ DTG_PREFIX }}.{{ ftype }}.tile{{ ntile }}.nc", "{{ COMOUT_ATMOS_RESTART_PREV }}"]
            {% endfor %} # ntile
        {% endfor %} # ftype
{% else %}
atmosphere_cold:
    mkdir:
        - "{{ COMOUT_ATMOS_INPUT }}"
    copy:
        - ["{{ ICSDIR }}/{{ COMOUT_ATMOS_INPUT | relpath(ROTDIR) }}/gfs_ctrl.nc", "{{ COMOUT_ATMOS_INPUT }}"]
        {% for ftype in ["gfs_data", "sfc_data"] %}
            {% for ntile in range(1, ntiles + 1) %}
        - ["{{ ICSDIR }}/{{ COMOUT_ATMOS_INPUT | relpath(ROTDIR) }}/{{ ftype }}.tile{{ ntile }}.nc", "{{ COMOUT_ATMOS_INPUT }}"]
            {% endfor %} # ntile
        {% endfor %} # ftype
{% endif %}

{% if MEMDIR and REPLAY_ICS == "YES" %}
atmosphere_perturbation:
    mkdir:
        - "{{ COMOUT_ATMOS_ANALYSIS }}"
    copy:
        - ["{{ ICSDIR }}/{{ COMOUT_ATMOS_ANALYSIS | relpath(ROTDIR) }}/{{ DTG_PREFIX }}.fv3_perturbation.nc", "{{ COMOUT_ATMOS_ANALYSIS }}/{{ RUN }}.t{{ cycle_HH }}z.atminc.nc"]
{% endif %}

{% if DO_NEST %}
atmosphere_nest:
    {% set ntile = 7 %}
    mkdir:
        - "{{ COMOUT_ATMOS_RESTART_PREV }}"
    copy:
        {% if EXP_WARM_START == True %}
            {% for ftype in ["ca_data", "fv_core.res", "fv_srf_wnd.res", "fv_tracer.res", "phy_data", "sfc_data"] %}
        - ["{{ ICSDIR }}/{{ COMOUT_ATMOS_RESTART_PREV | relpath(ROTDIR) }}/{{ DTG_PREFIX }}.{{ ftype }}.tile{{ ntile }}.nc", "{{ COMOUT_ATMOS_RESTART_PREV }}/{{ DTG_PREFIX }}.{{ ftype }}.nest0{{ ntile-5 }}.tile{{ ntile }}.nc"]
            {% endfor %} # ftype
        {% else %}
            {% for ftype in ["gfs_data", "sfc_data"] %}
        - ["{{ COMOUT_ATMOS_INPUT }}/{{ ftype }}.tile{{ ntile }}.nc", "{{ COMOUT_ATMOS_INPUT }}/{{ ftype }}.nest0{{ ntile-5 }}.tile{{ ntile }}.nc"]
            {% endfor %} # ftype
        {% endif %} # cold-start
{% endif %}

{% if DO_WAVE %}
wave:
    mkdir:
        - "{{ COMOUT_WAVE_RESTART_PREV }}"
    copy:
        - ["{{ ICSDIR }}/{{ COMOUT_WAVE_RESTART_PREV | relpath(ROTDIR) }}/{{ DTG_PREFIX }}.restart.{{ waveGRD }}", "{{ COMOUT_WAVE_RESTART_PREV }}"]
{% endif %}

{% if DO_OCN %}
ocean:
    mkdir:
        - "{{ COMOUT_OCEAN_RESTART_PREV }}"
    copy:
        - ["{{ ICSDIR }}/{{ COMOUT_OCEAN_RESTART_PREV | relpath(ROTDIR) }}/{{ DTG_PREFIX }}.MOM.res.nc", "{{ COMOUT_OCEAN_RESTART_PREV }}"]
        {% if OCNRES == "025" %}
            {% for nn in range(1, 3) %}
        - ["{{ ICSDIR }}/{{ COMOUT_OCEAN_RESTART_PREV | relpath(ROTDIR) }}/{{ DTG_PREFIX }}.MOM.res_{{ nn }}.nc", "{{ COMOUT_OCEAN_RESTART_PREV }}"]
            {% endfor %}
        {% endif %}
        {% if MEMDIR and REPLAY_ICS == "YES" %}
        - ["{{ ICSDIR }}/{{ COMOUT_OCEAN_ANALYSIS | relpath(ROTDIR) }}/{{ DTG_PREFIX }}.mom6_perturbation.nc", "{{ COMOUT_OCEAN_ANALYSIS }}/mom6_increment.nc"]
        {% endif %}
        {% if EXP_WARM_START == True %}
        - ["{{ ICSDIR }}/{{ COMOUT_MED_RESTART_PREV | relpath(ROTDIR) }}/{{ DTG_PREFIX }}.ufs.cpld.cpl.r.nc", "{{ COMOUT_MED_RESTART_PREV }}"]
        {% endif %}
{% endif %}

{% if DO_ICE %}
ice:
    mkdir:
        - "{{ COMOUT_ICE_RESTART_PREV }}"
    copy:
        - ["{{ ICSDIR }}/{{ COMOUT_ICE_RESTART_PREV | relpath(ROTDIR) }}/{{ DTG_PREFIX }}.cice_model.res.nc", "{{ COMOUT_ICE_RESTART_PREV }}"]
{% endif %}
