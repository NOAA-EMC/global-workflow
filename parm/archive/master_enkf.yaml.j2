{% set cycle_HH = current_cycle | strftime("%H") %}
{% set cycle_YMD = current_cycle | to_YMD %}
{% set cycle_YMDH = current_cycle | to_YMDH %}
datasets:
{% if ENSGRP == 0 %}
{% include "enkf.yaml.j2" %}
{% else %}

# Set variables/lists needed to parse the enkf templates
{% if IAUFHRS is string %}
{% set iaufhrs = [] %}
{% for iaufhr in IAUFHRS.split(",") %}
{% do iaufhrs.append(iaufhr | int) %}
{% endfor %}
{% else %}
{% set iaufhrs = [IAUFHRS] %}
{% endif %}

# Declare to-be-filled lists of member COM directories
{% set COM_ATMOS_ANALYSIS_MEM_list = [] %}
{% set COM_ATMOS_RESTART_MEM_list = [] %}
{% set COM_ATMOS_HISTORY_MEM_list = [] %}

{% set first_group_mem = (ENSGRP - 1) * NMEM_EARCGRP + 1 %}
{% set last_group_mem = [ ENSGRP * NMEM_EARCGRP, NMEM_ENS ] | min %}

{% for mem in range(first_group_mem, last_group_mem + 1) %}

# Declare a dict to get member COM directories from templates
{% set tmpl_dict = {'ROTDIR':ROTDIR, 'RUN':RUN, 'YMD':cycle_YMD, 'HH':cycle_HH, 'MEMDIR':"mem" + '%03d' % mem} %}

# Populate the member COM directories from the template
{% do COM_ATMOS_ANALYSIS_MEM_list.append(
      COM_ATMOS_ANALYSIS_TMPL | template_substitute_structure(DOLLAR_CURLY_BRACE,
                                                              tmpl_dict.get))
%}

{% do COM_ATMOS_HISTORY_MEM_list.append(
      COM_ATMOS_HISTORY_TMPL | template_substitute_structure(DOLLAR_CURLY_BRACE,
                                                              tmpl_dict.get))
%}

{% do COM_ATMOS_RESTART_MEM_list.append(
      COM_ATMOS_RESTART_TMPL | template_substitute_structure(DOLLAR_CURLY_BRACE,
                                                              tmpl_dict.get))
%}

{% endfor %}

# Determine which members to archive
{% include "enkf_grp.yaml.j2" %}
{% if current_cycle > SDATE %}
{% include "enkf_restarta_grp.yaml.j2" %}
{% include "enkf_restartb_grp.yaml.j2" %}
{% endif %}

{% endif %}  # ENSGRP != 0
